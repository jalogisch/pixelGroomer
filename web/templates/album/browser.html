{# Image browser with preview and sidebar #}
{% if photos %}
<div class="split-layout">
  <!-- Main: Image Viewer with Quick Actions -->
  <div class="split-main">
    <div class="card">
      <div class="card-body">
        <div class="image-viewer">
          <!-- Image Container -->
          <div class="image-container">
            {% if current_photo %}
            <img src="{{ url_for('api.get_thumbnail', photo_path=current_photo) }}" 
                 alt="{{ current_photo }}"
                 loading="lazy"
                 onerror="this.onerror=null; this.parentElement.innerHTML='<div style=\'padding: 3rem; text-align: center; color: var(--color-text-subdued);\'><p>Preview not available</p><p class=\'text-small\'>{{ photo_info.name if photo_info else current_photo }}</p></div>';">
            {% endif %}
          </div>
          
          <!-- Quick Actions Bar (Albums + Rating) - RIGHT BELOW IMAGE -->
          {% if current_photo %}
          <div class="quick-actions-bar">
            <!-- Albums (most important) -->
            <div class="quick-albums" id="album-checkboxes">
              {% include "album/partials/album_checkboxes.html" %}
            </div>
            
            <!-- Rating -->
            <div class="quick-rating">
              {% set current_rating = photo_info.rating if photo_info else 0 %}
              {% include "components/rating.html" with context %}
            </div>
          </div>
          {% endif %}
          
          <!-- Navigation -->
          <div class="image-nav">
            {% set prev_index = current_index - 1 if current_index > 0 else 0 %}
            {% set next_index = current_index + 1 if current_index < photos|length - 1 else photos|length - 1 %}
            
            <button class="btn btn-secondary"
                    data-nav="prev"
                    hx-get="{{ url_for('album.browser') }}"
                    hx-vals='{"folder": "{{ folder }}", "index": {{ prev_index }}}'
                    hx-target="#image-browser"
                    hx-swap="innerHTML"
                    {% if current_index == 0 %}disabled{% endif %}>
              ‚Üê Prev
            </button>
            
            <span class="image-counter">
              {{ current_index + 1 }} / {{ photos|length }}
            </span>
            
            <button class="btn btn-secondary"
                    data-nav="next"
                    hx-get="{{ url_for('album.browser') }}"
                    hx-vals='{"folder": "{{ folder }}", "index": {{ next_index }}}'
                    hx-target="#image-browser"
                    hx-swap="innerHTML"
                    {% if current_index >= photos|length - 1 %}disabled{% endif %}>
              Next ‚Üí
            </button>
          </div>
          
          <p class="text-subdued text-small" style="margin: 0;">
            ‚Üê ‚Üí keys to navigate | 1-5 to rate | 0 to clear rating
          </p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Sidebar: Collapsible Info & Actions -->
  <div class="split-sidebar">
    <!-- Create New Album (always visible) -->
    <div class="card">
      <div class="card-body" style="padding: 0.75rem;">
        <form hx-post="{{ url_for('api.create_album') }}"
              hx-target="#album-checkboxes"
              hx-swap="innerHTML"
              class="flex gap-2">
          <input type="text" 
                 class="form-input" 
                 name="name" 
                 placeholder="New album name"
                 style="flex: 1;">
          <button type="submit" class="btn btn-primary btn-small">
            + Create
          </button>
        </form>
      </div>
    </div>
    
    <!-- Photo Info (collapsible) -->
    <details class="card collapsible" open>
      <summary class="card-header collapsible-header">
        <h3 class="card-title">Photo Info</h3>
        <span class="collapsible-icon">‚ñº</span>
      </summary>
      <div class="card-body">
        {% if photo_info %}
        <div class="text-small photo-info-grid">
          <div class="photo-info-item">
            <span class="text-subdued">File:</span>
            <strong>{{ photo_info.name }}</strong>
          </div>
          
          {% if photo_info.date_taken %}
          <div class="photo-info-item">
            <span class="text-subdued">Date:</span>
            {{ photo_info.date_taken }}
          </div>
          {% endif %}
          
          <div class="photo-info-item">
            <span class="text-subdued">Size:</span>
            {{ photo_info.size_human }}
            {% if photo_info.dimensions %}| {{ photo_info.dimensions }}{% endif %}
          </div>
          
          {% if photo_info.is_raw %}
          <div class="photo-info-item">
            <span class="text-subdued">Type:</span>
            RAW ({{ photo_info.extension }})
          </div>
          {% endif %}
          
          {% if photo_info.camera %}
          <div class="photo-info-item">
            <span class="text-subdued">Camera:</span>
            {{ photo_info.camera }}
          </div>
          {% endif %}
          
          {% if photo_info.lens %}
          <div class="photo-info-item">
            <span class="text-subdued">Lens:</span>
            {{ photo_info.lens }}
          </div>
          {% endif %}
          
          {% if photo_info.exposure %}
          <div class="photo-info-item">
            <span class="text-subdued">Exposure:</span>
            {{ photo_info.exposure }}
          </div>
          {% endif %}
          
          {% if photo_info.author %}
          <div class="photo-info-item">
            <span class="text-subdued">Author:</span>
            {{ photo_info.author }}
          </div>
          {% endif %}
          
          {% if photo_info.gps %}
          <div class="photo-info-item">
            <span class="text-subdued">GPS:</span>
            <a href="https://www.google.com/maps?q={{ photo_info.gps | urlencode }}" 
               target="_blank" rel="noopener">üìç Map</a>
          </div>
          {% endif %}
        </div>
        {% endif %}
      </div>
    </details>
    
    <!-- Export (collapsible, closed by default) -->
    <details class="card collapsible">
      <summary class="card-header collapsible-header">
        <h3 class="card-title">Export Album</h3>
        <span class="collapsible-icon">‚ñº</span>
      </summary>
      <div class="card-body">
        <form hx-post="{{ url_for('api.export_album', album_name='selected') }}"
              hx-target="#export-result"
              hx-swap="innerHTML">
          <div class="form-group">
            <label class="form-label">Album</label>
            <select class="form-select" name="album_name">
              {% for album in albums %}
              <option value="{{ album.name }}">
                {{ album.name }} ({{ album.photo_count }})
              </option>
              {% endfor %}
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Watermark</label>
            <input type="text" 
                   class="form-input" 
                   name="watermark"
                   placeholder="Jan Doberstein - enduroXperience">
          </div>
          
          <div class="form-group">
            <label class="form-label">Max Size (KB)</label>
            <input type="number" 
                   class="form-input" 
                   name="max_size"
                   value="2048">
          </div>
          
          <div class="form-group">
            <label class="form-label">Output Directory</label>
            <div class="path-picker">
              <input type="text" 
                     class="form-input path-picker-input"
                     id="export-output-dir"
                     name="output_dir"
                     placeholder="~/Desktop/Export">
              <button type="button" 
                      class="btn btn-secondary path-picker-btn"
                      onclick="openPathPicker('export-output-dir', 'directory')">
                Browse
              </button>
            </div>
          </div>
          
          <button type="submit" class="btn btn-primary" style="width: 100%;"
                  {% if not albums %}disabled{% endif %}>
            Export Album
          </button>
        </form>
        <div id="export-result" class="mt-2"></div>
      </div>
    </details>
  </div>
</div>
{% else %}
<div class="card">
  <div class="card-body">
    <p class="text-subdued text-center">
      {% if folder %}
      No photos found in this folder.
      {% else %}
      Select a folder to browse photos.
      {% endif %}
    </p>
  </div>
</div>
{% endif %}
