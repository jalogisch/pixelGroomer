---
description: Bash 3.2 compatibility for macOS
globs: "**/*.sh,**/bin/pg-*"
alwaysApply: false
---

# Bash 3.2 Compatibility

macOS ships with Bash 3.2 by default. All scripts must be compatible.

## Forbidden Features (Bash 4.0+)

```bash
# ❌ Associative arrays (Bash 4.0+)
declare -A myarray

# ❌ Case modification (Bash 4.0+)
${var,,}   # lowercase
${var^^}   # uppercase

# ❌ Coproc (Bash 4.0+)
coproc command

# ❌ &>> append redirect (Bash 4.0+)
command &>> file

# ❌ |& pipe stderr (Bash 4.0+)
command |& other
```

## Correct Alternatives

```bash
# ✅ Lowercase - use tr
lower=$(echo "$var" | tr '[:upper:]' '[:lower:]')

# ✅ Uppercase - use tr  
upper=$(echo "$var" | tr '[:lower:]' '[:upper:]')

# ✅ Stderr redirect - use 2>&1
command >> file 2>&1

# ✅ Pipe stderr - use 2>&1
command 2>&1 | other

# ✅ Instead of associative arrays - use separate variables or files
# Or use nameref simulation with eval (carefully)
```

## Allowed Features

These work in Bash 3.2:

```bash
# ✅ Regular arrays
declare -a myarray=()

# ✅ Regex matching (basic)
[[ "$var" =~ ^[0-9]+$ ]]

# ✅ BASH_REMATCH for captures
if [[ "$date" =~ ^([0-9]{4})-([0-9]{2}) ]]; then
    year="${BASH_REMATCH[1]}"
fi

# ✅ Process substitution
diff <(cmd1) <(cmd2)

# ✅ Here strings
cat <<< "$var"
```

## Arithmetic with set -e

When using `set -e` (errexit), be careful with arithmetic expressions:

```bash
# ❌ WRONG: ((i++)) fails when i=0
local i=0
for item in "${items[@]}"; do
    ((i++))   # Returns exit code 1 when i=0, script exits!
done

# ✅ CORRECT: Use pre-increment ((++i))
local i=0
for item in "${items[@]}"; do
    ((++i))   # Returns 1 (new value), exit code 0
done

# ✅ Alternative: Use assignment
i=$((i + 1))
```

**Why?** The `((...))` construct returns exit code 1 when the expression evaluates to 0. Post-increment `((i++))` returns the OLD value (0), while pre-increment `((++i))` returns the NEW value (1).

This affects any counter that starts at 0:
- Loop counters (`((i++))`)
- Success/failure counters (`((success++))`)
- Any variable incremented from 0

## Testing

Test scripts on macOS default bash:

```bash
/bin/bash --version  # Should show 3.2.x
/bin/bash script.sh  # Test with system bash
```
